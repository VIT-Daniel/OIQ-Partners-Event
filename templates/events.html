<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Partner Events</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    .card {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      padding-top: 2.5rem;
    }

    .card-text {
      max-height: 100px;
      overflow: hidden;
      flex-grow: 1;
    }

    .btn {
      align-self: center;
    }

    .badge {
      font-size: 0.75rem;
      padding: 0.4em 0.6em;
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
    }

    .pagination {
      flex-wrap: wrap;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4 text-center">Partner Events</h1>

    <!-- 🔍 Search + Filters -->
    <div class="row mb-4">
      <div class="col-md-4">
        <input type="text" id="search" class="form-control" placeholder="Search events..." />
      </div>
      <div class="col-md-3">
        <select id="sourceFilter" class="form-select">
          <option value="">All Sources</option>
          <option value="AWS">AWS</option>
          <option value="NVIDIA">NVIDIA</option>
          <option value="UiPath">UiPath</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="categoryFilter" class="form-select">
          <option value="">All Categories</option>
          <option value="Webinar">Webinar</option>
          <option value="Conference">Conference</option>
          <option value="Training">Training</option>
        </select>
      </div>
      <div class="col-md-2">
        <button id="clearFilters" class="btn btn-secondary w-100">Clear</button>
      </div>
    </div>

    <!-- Event Cards -->
    <div id="eventGrid" class="row g-4"></div>

    <!-- Pagination -->
    <nav aria-label="Page navigation" class="mt-5">
      <ul id="pagination" class="pagination justify-content-center"></ul>
    </nav>
  </div>

  <script>
    const eventGrid = document.getElementById("eventGrid");
    const pagination = document.getElementById("pagination");
    let currentPage = 1;
    let totalPages = 1;

    // Fetch events dynamically
    async function fetchEvents(page = 1) {
      const q = document.getElementById("search").value.trim();
      const source = document.getElementById("sourceFilter").value;
      const category = document.getElementById("categoryFilter").value;

      const params = new URLSearchParams({
        page,
        q,
        source,
        category,
      });

      const response = await fetch(`/api/events?${params.toString()}`);
      const data = await response.json();

      renderEvents(data.events);
      renderPagination(data.start_page, data.end_page, data.page, data.total_pages);
    }

    // Render event cards
    function renderEvents(events) {
      eventGrid.innerHTML = "";

      if (!events || events.length === 0) {
        eventGrid.innerHTML = `<p class="text-center text-muted">No events found.</p>`;
        return;
      }

      events.forEach((event) => {
        const sourceColor =
          event.source === "AWS"
            ? "bg-warning text-dark"
            : event.source === "NVIDIA"
            ? "bg-success"
            : event.source === "UiPath"
            ? "bg-danger"
            : "bg-secondary";

        const card = `
          <div class="col-md-3 d-flex">
            <div class="card shadow-sm flex-fill position-relative">
              <span class="badge ${sourceColor}">${event.source || "Unknown"}</span>
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${event.title || "Untitled Event"}</h5>
                <p class="card-text">${event.description || "No description available."}</p>
                <p><small class="text-muted">${event.start_date || ""}</small></p>
                ${
                  event.register_link
                    ? `<div class="mt-auto text-center">
                        <a href="${event.register_link}" target="_blank" class="btn btn-primary btn-sm">Register</a>
                      </div>`
                    : ""
                }
              </div>
            </div>
          </div>`;
        eventGrid.insertAdjacentHTML("beforeend", card);
      });
    }

    // Render pagination buttons (1–10, Previous/Next)
    function renderPagination(startPage, endPage, currentPage, totalPages) {
      pagination.innerHTML = "";

      if (totalPages <= 1) return;

      // Previous button
      const prevDisabled = currentPage === 1 ? "disabled" : "";
      pagination.insertAdjacentHTML(
        "beforeend",
        `<li class="page-item ${prevDisabled}">
          <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
        </li>`
      );

      // Page numbers
      for (let i = startPage; i <= endPage; i++) {
        const active = i === currentPage ? "active" : "";
        pagination.insertAdjacentHTML(
          "beforeend",
          `<li class="page-item ${active}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>`
        );
      }

      // Next button
      const nextDisabled = currentPage === totalPages ? "disabled" : "";
      pagination.insertAdjacentHTML(
        "beforeend",
        `<li class="page-item ${nextDisabled}">
          <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
        </li>`
      );

      // Add event listeners
      document.querySelectorAll(".page-link").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          const page = parseInt(btn.dataset.page);
          if (!isNaN(page) && page >= 1 && page <= totalPages) {
            currentPage = page;
            fetchEvents(currentPage);
          }
        });
      });
    }

    // Filters + Search
    document.getElementById("search").addEventListener("input", () => fetchEvents(1));
    document.getElementById("sourceFilter").addEventListener("change", () => fetchEvents(1));
    document.getElementById("categoryFilter").addEventListener("change", () => fetchEvents(1));
    document.getElementById("clearFilters").addEventListener("click", () => {
      document.getElementById("search").value = "";
      document.getElementById("sourceFilter").value = "";
      document.getElementById("categoryFilter").value = "";
      fetchEvents(1);
    });

    // Initial load
    fetchEvents();
  </script>
</body>
</html>
